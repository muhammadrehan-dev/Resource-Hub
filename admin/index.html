<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - DUET Resource Hub</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <!-- Netlify CMS -->
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    
    <script>
        // Redirect to home if logged out
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }

        // Custom notification sender
        CMS.registerEventListener({
            name: 'postPublish',
            handler: ({ entry }) => {
                // Check if this is a news post with sendNotification = true
                if (entry.get('collection') === 'news' && entry.get('data').get('sendNotification')) {
                    const title = entry.get('data').get('title');
                    const body = entry.get('data').get('body');
                    
                    // Extract first 100 chars as message
                    const message = body.substring(0, 100) + '...';
                    
                    // Send notification via our secure function
                    fetch('/api/send-notification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: title,
                            message: message,
                            url: 'https://25fcyber.netlify.app/news/'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('✅ News published & notification sent to all subscribers!');
                        } else {
                            alert('⚠️ News published but notification failed: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('⚠️ News published but notification failed');
                    });
                }
            }
        });
    </script>
</body>
</html>
